name: Container Image SBOM using Trivy

on:
  workflow_dispatch:
    inputs:
      image_repository:
        description: 'Container Image Repository'
        required: true
        default: ''

env:
  OUTPUT_NAME: 'cyclonedxSBOM'
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    
    steps:
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ inputs.image_repository }}
          format: 'cyclonedx'
          template: '@/contrib/sarif.tpl'
          output: 'cyclonedx-SBOM.json'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          
      - name: Upload Trivy JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTPUT_NAME }}
          path: cyclonedx-SBOM.json
